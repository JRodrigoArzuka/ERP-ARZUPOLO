<div id="view-crm" class="view-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="m-0 text-primary"><i class="bi bi-diagram-3-fill"></i> Motor de Flujos</h2>
            <small class="text-muted">Configura c칩mo interact칰a el bot con tus clientes y pedidos.</small>
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" onclick="cargarCRM()">
                <i class="bi bi-arrow-clockwise"></i> Recargar
            </button>
            <button class="btn btn-success fw-bold px-4 shadow-sm" onclick="abrirModalCRM()">
                <i class="bi bi-plus-lg"></i> Nueva Regla
            </button>
        </div>
    </div>

    <!-- LISTA DE REGLAS -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">ID Regla</th>
                            <th>Tipo</th>
                            <th>Disparador</th>
                            <th>Acci칩n</th>
                            <th>Men칰</th>
                            <th>Estado</th>
                            <th class="text-end pe-4">Editar</th>
                        </tr>
                    </thead>
                    <tbody id="tblCrmBody">
                        <tr><td colspan="7" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: EDITOR DE REGLA 7.0 -->
<div class="modal fade" id="modalCRM" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="bi bi-robot me-2"></i> Configurar Regla</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0">
                <!-- NAVEGACI칍N PESTA칌AS -->
                <ul class="nav nav-tabs nav-fill bg-light fw-bold" id="tabsCRM" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active py-3" data-bs-toggle="tab" data-bs-target="#tab-crm-logic">
                            <i class="bi bi-gear-fill me-1"></i> L칩gica
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-crm-content">
                            <i class="bi bi-chat-dots-fill me-1"></i> Respuesta
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link py-3" data-bs-toggle="tab" data-bs-target="#tab-crm-actions">
                            <i class="bi bi-lightning-fill me-1"></i> Acciones
                        </button>
                    </li>
                </ul>

                <div class="tab-content p-4">
                    
                    <!-- TAB 1: L칍GICA (DISPARADOR) -->
                    <div class="tab-pane fade show active" id="tab-crm-logic">
                        <form id="formCRM">
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="small fw-bold text-muted">ID Regla (칔nico)</label>
                                    <input type="text" id="txtCrmId" class="form-control font-monospace fw-bold" placeholder="ej: bot_saludo">
                                </div>
                                <div class="col-md-4">
                                    <label class="small fw-bold text-muted">Estado</label>
                                    <div class="form-check form-switch p-2 border rounded bg-light">
                                        <input class="form-check-input ms-0 me-2" type="checkbox" id="chkCrmActivo" checked>
                                        <label class="form-check-label fw-bold" for="chkCrmActivo">Activa</label>
                                    </div>
                                </div>

                                <div class="col-12"><hr></div>

                                <!-- SELECTOR PRINCIPAL -->
                                <div class="col-12 text-center mb-3">
                                    <label class="fw-bold mb-2">쯈ui칠n inicia esta interacci칩n?</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="crmOrigen" id="optSistema" value="SISTEMA" onchange="toggleCrmMode()">
                                        <label class="btn btn-outline-primary py-3" for="optSistema">
                                            <i class="bi bi-hdd-rack fs-4 d-block"></i>
                                            SISTEMA<br><small>Cambio de Estado</small>
                                        </label>

                                        <input type="radio" class="btn-check" name="crmOrigen" id="optCliente" value="CLIENTE" onchange="toggleCrmMode()" checked>
                                        <label class="btn btn-outline-success py-3" for="optCliente">
                                            <i class="bi bi-person-fill fs-4 d-block"></i>
                                            CLIENTE<br><small>Env칤a un Mensaje</small>
                                        </label>
                                    </div>
                                </div>

                                <!-- MODO CLIENTE (BOT) -->
                                <div id="panelCrmCliente" class="row g-3">
                                    <div class="col-md-8">
                                        <label class="small fw-bold text-muted">Palabra Clave (Disparador)</label>
                                        <input type="text" id="txtCrmKeyword" class="form-control fw-bold" placeholder="Ej: HOLA, PRECIO, CARTA">
                                        <small class="text-muted">Si el cliente escribe esto...</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="small fw-bold text-muted">Coincidencia</label>
                                        <select id="selCrmMatch" class="form-select">
                                            <option value="EXACTA">Exacta (Solo esa palabra)</option>
                                            <option value="CONTIENE">Contiene (Frase completa)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- CONFIGURACI칍N DE MEN칔 -->
                                    <div class="col-12">
                                        <div class="card bg-warning bg-opacity-10 border-warning mt-2">
                                            <div class="card-body">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" type="checkbox" id="chkCrmMenu" onchange="toggleCrmMenu()">
                                                    <label class="form-check-label fw-bold" for="chkCrmMenu">Mostrar en el Men칰 Autom치tico</label>
                                                </div>
                                                <div id="divCrmMenuText" class="mt-2 d-none">
                                                    <label class="small fw-bold text-muted">Texto del Bot칩n en el Men칰</label>
                                                    <input type="text" id="txtCrmMenuDesc" class="form-control" placeholder="Ej: 游늶 Ver nuestra Carta">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- MODO SISTEMA (NOTIFICACI칍N) -->
                                <div id="panelCrmSistema" class="row g-3 d-none">
                                    <div class="col-12">
                                        <label class="small fw-bold text-muted">Cuando el pedido cambie al estado:</label>
                                        <select id="selCrmEstadoTrigger" class="form-select border-primary fw-bold"></select>
                                    </div>
                                </div>

                            </div>
                        </form>
                    </div>

                    <!-- TAB 2: CONTENIDO (RESPUESTA) -->
                    <div class="tab-pane fade" id="tab-crm-content">
                        <label class="small fw-bold text-muted mb-2">Variables Disponibles</label>
                        <div class="mb-3 d-flex flex-wrap gap-1">
                            <span class="badge bg-secondary cursor-pointer" onclick="insertarTag('{{cliente}}')">Cliente</span>
                            <span class="badge bg-secondary cursor-pointer" onclick="insertarTag('{{nombre_corto}}')">Nombre Corto</span>
                            <span class="badge bg-secondary cursor-pointer" onclick="insertarTag('{{ticket}}')"># Ticket</span>
                            <span class="badge bg-info text-dark cursor-pointer" onclick="insertarTag('{{total}}')">Total</span>
                            <span class="badge bg-info text-dark cursor-pointer" onclick="insertarTag('{{pendiente}}')">Saldo</span>
                            <span class="badge bg-warning text-dark cursor-pointer" onclick="insertarTag('{{fecha_entrega}}')">F. Entrega</span>
                        </div>
                        
                        <label class="small fw-bold text-muted">Mensaje de Respuesta</label>
                        <textarea id="txtCrmMensaje" class="form-control mb-4" rows="5" placeholder="Escribe aqu칤 lo que dir치 el bot..."></textarea>

                        <!-- SUBIDA DE ARCHIVO -->
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <label class="small fw-bold text-muted mb-2"><i class="bi bi-paperclip"></i> Adjunto (Opcional)</label>
                                <div class="input-group mb-2">
                                    <input type="file" id="fileCrmAdjunto" class="form-control">
                                    <button class="btn btn-secondary" type="button" onclick="subirArchivoAdjunto()">Subir</button>
                                </div>
                                <input type="text" id="txtCrmAdjunto" class="form-control form-control-sm bg-white" readonly placeholder="URL del archivo...">
                                <small id="lblEstadoSubida" class="text-muted"></small>
                            </div>
                        </div>
                    </div>

                    <!-- TAB 3: ACCIONES AUTOM츼TICAS -->
                    <div class="tab-pane fade" id="tab-crm-actions">
                        <div class="alert alert-primary border-0 shadow-sm mb-4">
                            <i class="bi bi-robot me-2"></i> Adem치s de responder, 쯤uieres que el sistema haga algo?
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="small fw-bold text-muted">Cambiar Estado del Pedido a:</label>
                                <select id="selCrmAccionEstado" class="form-select">
                                    <option value="">(No cambiar estado)</option>
                                    <!-- Se llena con JS -->
                                </select>
                                <small class="text-muted" style="font-size:0.75rem">칔til para confirmaciones ("Aprobado").</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="small fw-bold text-muted">Ejecutar Funci칩n Especial:</label>
                                <select id="selCrmAccionFuncion" class="form-select">
                                    <option value="">(Ninguna)</option>
                                    <option value="BUSCAR_PEDIDO">游댌 Buscar Estado de Pedido</option>
                                    <option value="VER_PUNTOS">游끥 Consultar Puntos</option>
                                    <option value="AVISAR_ASESOR">游뚿 Notificar a Humano</option>
                                </select>
                                <small class="text-muted" style="font-size:0.75rem">L칩gica avanzada del sistema.</small>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-danger me-auto" id="btnEliminarCRM" onclick="eliminarRegla()">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary fw-bold px-4" onclick="guardarRegla()">
                    <i class="bi bi-save"></i> Guardar Regla
                </button>
            </div>
        </div>
    </div>
</div>